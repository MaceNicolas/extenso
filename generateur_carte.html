<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Générateur de Carte</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: "dmSansFont", "dmSansFont Fallback", sans-serif;
            background-color: #f8f9fa; /* Fond clair */
            padding: 20px;
            color: #333;
        }

        h1, h2 {
            color: #8704af; /* Violet principal */
            margin-bottom: 20px;
        }

        /* Design Carré */
        .form-section {
            background-color: white; 
            padding: 20px;
            border: 1px solid #ced4da;
            box-shadow: 2px 2px 0px 0px #ced4da;
        }

        label {
            font-weight: 600;
            color: #8704af;
        }

        #map {
            width: 400px;
            height: 400px;
            border: 2px solid #8704af; 
        }

        /* Bouton Principal: Violet */
        .btn-main {
            background-color: #8704af;
            color: white;
            border: 1px solid #6a0390;
            transition: background-color 0.3s ease;
        }

        .btn-main:hover {
            background-color: #6a0390;
            color: white;
        }

        /* Bouton Secondaire: Rose */
        .btn-secondary-custom {
            background-color: #ff99cc; 
            color: #333;
            border: 1px solid #ff66aa;
            transition: background-color 0.3s ease;
        }

        .btn-secondary-custom:hover {
            background-color: #ff66aa;
            color: white;
        }

        .row.centered {
            justify-content: center;
            gap: 20px;
        }

        /* Section Astuce: Bordure nette */
        .astuce-section {
            background-color: white;
            border: 1px solid #ced4da; 
            border-left: 5px solid #ff99cc;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
            color: #333;
            box-shadow: 1px 1px 0px 0px rgba(0, 0, 0, 0.1);
        }

        .astuce-section a {
            color: #8704af;
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="container text-center">
    <h1>Générateur de Carte</h1>

    <div class="row centered">
        <div class="col-md-4 form-section">
            <div class="mb-3">
                <label for="ville" class="form-label">Nom de la ville :</label>
                <input type="text" class="form-control" id="ville" placeholder="Ex: Villeurbanne">
            </div>
            <div class="mb-3">
                <label for="lat" class="form-label">Latitude :</label>
                <input type="text" class="form-control" id="lat" placeholder="">
            </div>
            <div class="mb-3">
                <label for="lon" class="form-label">Longitude :</label>
                <input type="text" class="form-control" id="lon" placeholder="">
            </div>
            <div class="mb-3">
                <label for="zoom" class="form-label">Zoom :</label>
                <input type="number" class="form-control" id="zoom" value="5" min="1" max="18">
            </div>
            <div class="d-grid gap-2">
                <button id="generate" class="btn btn-main">Générer la carte</button>
                <button id="save" class="btn btn-secondary-custom">Enregistrer la vue</button> 
                <button id="save-geojson" class="btn btn-secondary-custom">Télécharger GeoJSON</button>
            </div>
        </div>

        <div class="col-md-4 d-flex justify-content-center">
            <div id="map"></div>
        </div>
    </div>

    <div class="row centered">
        <div class="col-md-8 astuce-section">
            <h2>Astuces techniques</h2>
            <ul>
                <li>Il faut d'abord obtenir le <strong>CODE</strong> de la ville : 
                    <a href="https://geo.api.gouv.fr/communes?nom=VILLE" target="_blank">https://geo.api.gouv.fr/communes?nom=VILLE</a>
                </li>
                <li>Pour obtenir la <strong>longitude et latitude</strong> : 
                    <a href="https://geo.api.gouv.fr/communes?code=CODE&format=geojson&geometry=centre" target="_blank">https://geo.api.gouv.fr/communes?code=CODE&format=geojson&geometry=centre</a>
                </li>
                <li>Pour avoir le <strong>geojson complet</strong> : 
                    <a href="https://geo.api.gouv.fr/communes?code=CODE&format=geojson&geometry=contour" target="_blank">https://geo.api.gouv.fr/communes?code=CODE&format=geojson&geometry=contour</a>
                </li>

            </ul>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mapbox/leaflet-image@0.4.0/leaflet-image.js"></script>

<script>
    let map;
    let marker;
    let isCitySearch = false; 
    let currentVilleName = ''; // Global pour le nommage des fichiers
    let currentVilleCode = ''; // Global pour l'appel GeoJSON contour

    async function fetchVilleData(ville) {
        // 1. Récupérer le code INSEE
        const response = await fetch(`https://geo.api.gouv.fr/communes?nom=${ville}`);
        const data = await response.json();
        if (data.length === 0) {
            return null;
        }
        const code = data[0].code;
        
        // 2. Récupérer les coordonnées centrales
        const centreResponse = await fetch(`https://geo.api.gouv.fr/communes?code=${code}&format=geojson&geometry=centre`);
        const centreData = await centreResponse.json();
        const lat = centreData.features[0].geometry.coordinates[1];
        const lon = centreData.features[0].geometry.coordinates[0];
        
        return { lat, lon, code, name: data[0].nom };
    }

    document.getElementById('ville').addEventListener('change', async function() {
        const ville = this.value.trim();
        if (!ville) return;

        const data = await fetchVilleData(ville);
        
        if (!data) {
            alert("Ville non trouvée !");
            currentVilleCode = '';
            currentVilleName = '';
            return;
        }

        document.getElementById('lat').value = data.lat;
        document.getElementById('lon').value = data.lon;
        
        // Stockage des variables globales
        currentVilleCode = data.code;
        currentVilleName = data.name;

        // Générer automatiquement la carte
        isCitySearch = true;
        generateMap(data.lat, data.lon);
    });

    document.getElementById('generate').addEventListener('click', function() {
        const lat = parseFloat(document.getElementById('lat').value);
        const lon = parseFloat(document.getElementById('lon').value);
        
        const villeInput = document.getElementById('ville').value.trim();
        isCitySearch = !!villeInput; 

        // Si la génération est manuelle, on reset les données ville/code
        if (!isCitySearch) {
            currentVilleCode = '';
            currentVilleName = '';
        }
        
        generateMap(lat, lon);
    });

    function generateMap(lat, lon) {
        const zoom = parseInt(document.getElementById('zoom').value) || 5;
        if (!lat || !lon) {
            alert("Latitude ou longitude manquante !");
            return;
        }

        if (!map) {
            map = L.map('map', {
                center: [lat, lon],
                zoom: zoom,
                dragging: false,
                touchZoom: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                zoomControl: false
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        } else {
            map.setView([lat, lon], zoom);
            if (marker) map.removeLayer(marker);
        }

        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        marker = L.marker([lat, lon], { icon: redIcon }).addTo(map);
    }

    document.getElementById('save').addEventListener('click', function() {
        if (!map) {
            alert("Générez d'abord la carte !");
            return;
        }

        let filename = 'carte';
        
        // Déterminer le nom de fichier
        if (currentVilleName) { 
            // Si une ville a été chargée, utiliser son nom
            filename = currentVilleName.toLowerCase().replace(/\s+/g, '_');
        } else {
            // Sinon, utiliser le terme générique "carte"
            filename = 'carte'; 
        }

        leafletImage(map, function(err, canvas) {
            if (err) {
                alert("Erreur lors de la génération de l'image : " + err);
                return;
            }

            const canvas400 = document.createElement('canvas');
            canvas400.width = 400;
            canvas400.height = 400;
            const ctx = canvas400.getContext('2d');
            ctx.drawImage(canvas, 0, 0, 400, 400);

            const link = document.createElement('a');
            link.download = filename + '_vue.png'; // Ajout de _vue pour distinguer
            link.href = canvas400.toDataURL();
            link.click();
        });
    });

    /* NOUVELLE FONCTION POUR LE TÉLÉCHARGEMENT GEOJSON */
    async function saveGeoJson() {
        if (!currentVilleCode) {
            alert("Veuillez d'abord rechercher et charger une ville pour télécharger le GeoJSON (code INSEE manquant).");
            return;
        }

        try {
            const contourResponse = await fetch(`https://geo.api.gouv.fr/communes?code=${currentVilleCode}&format=geojson&geometry=contour`);
            const geoJsonData = await contourResponse.json();

            const filename = currentVilleName.toLowerCase().replace(/\s+/g, '_') + '_contour.geojson';
            
            // Création du blob pour le téléchargement
            const blob = new Blob([JSON.stringify(geoJsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            link.click();

            URL.revokeObjectURL(url); 
            
        } catch (error) {
            alert("Erreur lors de la récupération ou de l'enregistrement du GeoJSON: " + error);
        }
    }

    document.getElementById('save-geojson').addEventListener('click', saveGeoJson);
</script>
</body>
</html>
